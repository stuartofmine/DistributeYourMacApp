# Mac app和pkg签名公证盖章流程手册
## 前言
在我不算很长的开发经历中，MacOS 平台上的软件分发是最让人头大的。作为一个门外汉，即使有着官方文档作为指引，也非常容易卡在某些稀奇古怪的地方（是的，我知道你耳熟能详的企业和机构中有人被卡了几周乃止几个月）。比未知的关卡更可怕的是落后的工具，我刚开始接手开发工作时，需要使用命令行将一个 App 编译成 .pkg 并执行某些脚本和操作，这种体验堪比上古时代的刀耕火种。

为了打破这种不幸，我写下了这本操作手册。原本它只是我为某个机构的非技术人员撰写的培训手册，但是随着时间的推移，越来越多的同事和非同事向我索要这本手册。既然流传已经不可避免，使用的资料也可以公开查询到，索性公开以造福广大同行。其中必然有错漏的地方，欢迎指正。

## 你需要预先知道的知识
在 MacOS 上，应用程序以 .app 的形式存放于用户电脑上。应用程序分发有两种。
1. 可以通过官方的App Store下载，直接下载下来就是一个app。它需要遵循应用商店的审核规范和沙盒机制。
2. 在你的网站上放一个链接，用户通过这个链接下载 .pkg 或者 .dmg 格式的文件，这个文件包含了 .app文件。下载完成之后，再双击这个文件，进行手动的安装。pkg文件的好处在于方便执行安装之后或者安装之前的脚本，比如安装之前卸载旧 App ,检测系统版本，安装完成之后自动打开 App ,乃至修改用户的某些系统设置，这些都可以，也无需遵守沙盒机制。因此，需要较高权限的软件通常采用第二种形式的pkg格式进行分发。本文也主要针对此种形式进行讲解。

在 .app 和 .pkg 上，你都需要执行三件事：
1. 签名。
2. 公证。
3. 盖章。

其中，如果是以 .pkg 中包含了 .app 的形式进行分发，那么对 .app 的操作可以省略。但是我仍然建议你不要省略这几步，因为**问题暴露的时间越早越好。**

## 签名

### 什么叫签名

代码/应用签名是一种 macOS 安全技术，用于证明应用程序的来源。一旦应用程序被签名，系统就可以检测到应用程序的任何更改。无论更改是意外引入的还是由恶意代码引入的，比如对应用程序进行任何修改都会使签名失效。
发布pkg安装包时，需要使用的签名证书有两个：Developer ID application 和Developer ID installer。其中，Developer ID application用于给pkg安装包内部的app做签名， Developer ID installer 用于给pkg安装包本身做签名。
Developer ID 证书自创建之日起 5 年内有效；2017 年 2 月 22 日之前生成的 Developer ID 预置描述文件会随 Developer ID 证书一起到期。
对于pkg文件，如果用于签名的 Developer ID installer证书已过期，则必须使用有效的 Developer ID installer 证书重新签名，pkg才能正常安装。
撤销删除 Developer ID App 证书 并不是随意操作的，不管你的苹果开发者账号的角色是什么，均需通过 product-security@apple.com 向 Apple 发送请求，才可以删除。
对于所有 Developer ID App，如果用于签名的证书已被撤销，那么相应的 App 就无法再进行安装，已安装的 App 也会无法启动。

